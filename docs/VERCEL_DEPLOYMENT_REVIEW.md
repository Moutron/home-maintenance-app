# Vercel Deployment Review

This document summarizes what your **technology stack** requires for Vercel and what is already correct vs. what to fix or configure.

---

## 1. Stack Overview (What Vercel Sees)

| Layer | Technology | Vercel compatibility |
|-------|------------|------------------------|
| Framework | Next.js 16 (App Router) | ✅ Native |
| Auth | Clerk (`@clerk/nextjs`) | ✅ Serverless-friendly |
| Database | PostgreSQL via Prisma | ✅ Use pooled URL (e.g. Neon) |
| Config | `prisma.config.ts` + `schema.prisma` | ⚠️ Requires `DATABASE_URL` at **build** time |
| Sentry | `@sentry/nextjs` | ✅ Optional; build succeeds without token |
| Middleware | Clerk + in-memory rate limit | ✅ Edge-compatible (no Node-only APIs) |
| Output | Next.js `output` | ⚠️ Use **default** on Vercel (see §2) |

---

## 2. What’s Required for the Build to Succeed

### 2.1 Environment variables (must be set in Vercel → Settings → Environment Variables)

- **`DATABASE_URL`** (required for build and runtime)  
  - `prisma generate` is part of `npm run build`. Prisma loads `prisma.config.ts`, which references `env("DATABASE_URL")`. If `DATABASE_URL` is missing, the build fails with:  
    `PrismaConfigEnvError: Missing required environment variable: DATABASE_URL`  
  - Use a **pooled** Postgres URL (e.g. Neon pooled connection string).  
  - Add for **Production** (and **Preview** if you use preview deploys).

- **Clerk** (required for auth at runtime):  
  - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`  
  - `CLERK_SECRET_KEY`  

- **App URL** (recommended):  
  - `NEXT_PUBLIC_APP_URL` — set to your Vercel URL (e.g. `https://your-app.vercel.app`) after first deploy.

- **OpenAI** (only if you use AI features):  
  - `OPENAI_API_KEY` — routes that need it check and return 501 when unset.

Optional: `NEXT_PUBLIC_SENTRY_DSN`, `SENTRY_DSN`, `SENTRY_ORG`, `SENTRY_PROJECT`, `SENTRY_AUTH_TOKEN` (for source maps/releases), `CRON_SECRET` (for cron routes).

### 2.2 Build command

- Use **`npm run build`** (do not override with `next build` only).  
- Your `package.json` has `"build": "prisma generate && next build"`, so the Prisma client is generated before the Next.js build. Leave this as-is in Vercel.

### 2.3 Next.js `output` (fixed in code)

- **Issue:** `output: 'standalone'` is intended for self-hosted/Docker (single Node server). Vercel deploys **serverless functions** and does not use the standalone output; using it in production can conflict with Vercel’s build.  
- **Fix:** The app is configured so that when the build runs **on Vercel** (`VERCEL=1`), `output` is not set (Vercel’s default serverless behavior). When not on Vercel (e.g. Docker), `output: 'standalone'` is still used. See `next.config.ts`.

---

## 3. What’s Already Correct

- **Schema enums:** App and lib use `@/lib/schema-enums` for `TaskCategory`, `TaskFrequency`, `BudgetAlertStatus`, etc., and do not rely on enum exports from `@prisma/client` at build time. Prisma namespace (`Prisma.*`) and `PrismaClient` are still imported from `@prisma/client` (generated by `prisma generate`).  
- **TypeScript:** With `strict: true`, the codebase has been adjusted so `next build` passes (no implicit `any` in the paths that run during build). See `docs/IMPLICIT_ANY_DEPLOY_CHECKLIST.md`.  
- **Middleware:** Uses only Edge-compatible APIs (Headers, Map, etc.).  
- **Cron:** `vercel.json` defines the warranty check cron; optional env `CRON_SECRET` for cron route protection.  
- **Sentry:** Build completes even without `SENTRY_AUTH_TOKEN`; Sentry then warns and skips release/source map upload.

---

## 4. Post-deploy (one-time)

- **Migrations:** Vercel does not run Prisma migrations. Run once against your production DB:  
  `DATABASE_URL="<your-neon-url>" npx prisma migrate deploy`  
- **App URL:** After the first deploy, set `NEXT_PUBLIC_APP_URL` to the real Vercel URL and redeploy so links in emails and app use the correct origin.

---

## 5. Quick checklist before each deploy

- [ ] `DATABASE_URL` set in Vercel (Production, and Preview if needed).  
- [ ] Build command is **npm run build** (default).  
- [ ] `npm run build` passes locally with `DATABASE_URL` set (e.g. in `.env` or `.env.local`).  
- [ ] No enum imports from `@prisma/client` in app/lib (use `@/lib/schema-enums`).  
- [ ] `next.config.ts` does not force `output: 'standalone'` on Vercel (handled by `VERCEL` check).

---

## 6. Related docs

- **Step-by-step Vercel setup:** [docs/VERCEL_SETUP.md](VERCEL_SETUP.md)  
- **Implicit any / TypeScript:** [docs/IMPLICIT_ANY_DEPLOY_CHECKLIST.md](IMPLICIT_ANY_DEPLOY_CHECKLIST.md)  
- **Production checklist:** [docs/PRODUCTION_READINESS.md](PRODUCTION_READINESS.md)
